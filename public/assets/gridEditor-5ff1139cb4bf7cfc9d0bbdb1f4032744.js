function initTabs(){$(function(){$("#tabs").tabs()})}function createDraggableCellHelper(t){var e=$(t.currentTarget),i=e.find(".contentCellTitle").html(),s=e.find(".contentCellDescription").html(),l="<div class='dragHelper'>";return l+=e.find(".contentCellPosterImage img").attr("src").length>0?e.find(".contentCellPosterImage").html():"<span id='class='cell-title'>"+i+"</span>						<br><span class='cell-content'>"+s+"</span></div>",l+="</div>"}function createUsedContentRow(t,e,i,s,l){var n="<div id='usedContentCell_"+t+"' class='row-fluid contentCell usedCell'>									<div class='span1 contentCellPosterImage'></div>									<div class='span9'>										<span class='badge'></span>										<h5 class='contentCellTitle'></h5>										<p class='contentCellDescription'></p>									</div>									<div class='span2 contentCellEditButton'>Edit Info</div>								</div>";$("#usedContentCellTable").prepend(n);var r=$("#usedContentCell_"+t);r.find(".contentCellPosterImage").append("<img src='"+e+"' />"),r.find(".contentCellTitle").append(i),r.find(".contentCellDescription").append(s),r.find(".badge").html(l),$("#usedContentCellTable div").hover(onMouseIn,onMouseOut)}function initTableEvents(){$("#usedContentCellTable").on("click",".contentCellEditButton",editCellInformation)}function GridCell(t){this.class="cell ui-widget-content",this.updateData(t),this.init()}function Grid(t,e,i,s,l,n){this.width=t*parseInt(l),this.height=e*parseInt(n),this.boundsWidth=i*parseInt(l),this.boundsHeight=s*parseInt(n),this.widthStep=l,this.heightStep=n,this.cells=[],this.container=$("#grid"),this.parentContainer=$("#boundsForGrid"),this.cellSelected=!1,this.init()}function initFilter(){function t(t){var e=new RegExp(t,"i"),i=[];return _.each(o,function(t,s){t.match(e)&&i.push(r[s])}),i}function e(){var e=APPLICATION.cells;return _.isEmpty(h)||(e=t(h)),"all"!==a&&(e=_.filter(e,function(t){return t.type==a})),e}function i(){var t="";return $.each(e(),function(e,i){t+=d(i)}),t}function s(){$("#availableContentCellTable").html(i()).off("dragstop",".availableCell",onDrop).on("dragstop",".availableCell",onDrop).find(".availableCell").draggable({opacity:.7,helper:createDraggableCellHelper,cursorAt:{left:5,top:5},revert:!1})}var l=$("select#cellType"),n=$("input#searchTerm"),r={},o={},a="all",h="",d=_.template('<div id="availableContentCell_<%= id %>" class="row-fluid contentCell availableCell"><div class="contentCellPosterImage span1"><img src="<%= poster_image.url %>"></div><div class="span10"><h5 class="contentCellTitle"><span class="badge"><%= type %></span> <%= title %></h5><p class="contentCellDescription"><%= description %></p></div></div>');n.on("keyup change",_.debounce(function(t){h=t.target.value,s()},150)),l.on("change",function(){a=l.find("option:selected").val(),s()}),$.each(APPLICATION.cells,function(t,e){r[e.id]=e,o[e.id]=JSON.stringify(e)}),s()}function EditDialog(t,e,i,s){this.title=t,this.type=e,this.description=i,this.posterImage=s,this.init()}function setScrollbarHeight(){$(".cellTable").height($(window).height()-$("#boundsForGrid").height()-360)}function populateTheGrid(t){$.each(t,function(t,e){createGridCell(e)})}function onDrop(t){var e=$(t.target),i=e.attr("id");e.find(".contentCellTitle").html(),e.find(".contentCellDescription").html(),e.find(".contentCellPosterImage img").attr("src");var s=theGrid.container,l=s.offset();if(l.left<currentMousePos.x&&currentMousePos.x<l.left+s.width()&&l.top<currentMousePos.y&&currentMousePos.y<l.top+s.height()){i=i.split("_")[1],$.each(theGrid.cells,function(t,e){i==e.id&&(i+="-2")});var n=APPLICATION.score_id,r=APPLICATION.resource_id,o=theGrid.mapPixelsToGrid(currentMousePos.x-l.left,currentMousePos.y-l.top),a={cell_id:i,x:o.x,y:o.y};$.post(Routes.cell_set_grid_cells_path(n,r),{grid_cell:a},createGridCell)}}function createGridCell(t){var e=new GridCell(t);theGrid.addCell(e);var i=e.title||e.canonicalCell.title,s=e.description||e.canonicalCell.description;createUsedContentRow(e.id,e.src,i,s,e.canonicalCell.type)}function editCellInformation(t){var e=getIdOfHoveredCell(t);theGrid.setCurrentCell(e),editBox.openDialog(currentCellToEdit)}function onMouseIn(t){var e=getIdOfHoveredCell(t);$("#usedContentCell_"+e).addClass("activeCell"),$("#gridCell_"+e).addClass("activeCell")}function onMouseOut(t){var e=getIdOfHoveredCell(t);$("#usedContentCell_"+e).removeClass("activeCell"),$("#gridCell_"+e).removeClass("activeCell")}function removeSelectedCell(){theGrid.removeCell(currentCellToEdit)}function getIdOfHoveredCell(t){var e;return e=$(t.currentTarget).attr("id")?$(t.currentTarget).attr("id"):$(t.currentTarget).parent().attr("id"),e=e.split("_")[1]}(function(){var t,e,i,s,l={}.hasOwnProperty;e=function(t){this.message=t},e.prototype=new Error,s={prefix:"",default_url_options:{}},t={GROUP:1,CAT:2,SYMBOL:3,OR:4,STAR:5,LITERAL:6,SLASH:7,DOT:8},i={serialize:function(t,e){var i,s,n,r,o,a,h,d;if(null==e&&(e=null),!t)return"";if(!e&&"object"!==this.get_object_type(t))throw new Error("Url parameters should be a javascript hash");if(window.jQuery)return o=window.jQuery.param(t),o?o:"";switch(a=[],this.get_object_type(t)){case"array":for(s=h=0,d=t.length;d>h;s=++h)i=t[s],a.push(this.serialize(i,e+"[]"));break;case"object":for(n in t)l.call(t,n)&&(r=t[n],null!=r&&(null!=e&&(n=""+e+"["+n+"]"),a.push(this.serialize(r,n))));break;default:t&&a.push(""+encodeURIComponent(e.toString())+"="+encodeURIComponent(t.toString()))}return a.length?a.join("&"):""},clean_path:function(t){var e;return t=t.split("://"),e=t.length-1,t[e]=t[e].replace(/\/+/g,"/").replace(/.\/$/m,""),t.join("://")},set_default_url_options:function(t,e){var i,l,n,r,o;for(o=[],i=n=0,r=t.length;r>n;i=++n)l=t[i],!e.hasOwnProperty(l)&&s.default_url_options.hasOwnProperty(l)?o.push(e[l]=s.default_url_options[l]):o.push(void 0);return o},extract_anchor:function(t){var e;return e="",t.hasOwnProperty("anchor")&&(e="#"+t.anchor,delete t.anchor),e},extract_options:function(t,e){var i;return i={},e.length>t&&(i=e.pop()),i},path_identifier:function(t){var e;return 0===t?"0":t?(e=t,"object"===this.get_object_type(t)&&(e=t.to_param||t.id||t,"function"===this.get_object_type(e)&&(e=e.call(t))),e.toString()):""},clone:function(t){var e,i,s;if(null==t||"object"!==this.get_object_type(t))return t;i=t.constructor();for(s in t)l.call(t,s)&&(e=t[s],i[s]=e);return i},prepare_parameters:function(t,e,i){var s,l,n,r,o;for(l=this.clone(i)||{},s=r=0,o=t.length;o>r;s=++r)n=t[s],l[n]=e[s];return l},build_path:function(t,e,s,l){var n,r,o,a,h,d;if(l=Array.prototype.slice.call(l),r=this.extract_options(t.length,l),l.length>t.length)throw new Error("Too many parameters provided for path");return o=this.prepare_parameters(t,l,r),this.set_default_url_options(e,o),n=this.extract_anchor(o),a=""+this.get_prefix()+this.visit(s,o),h=i.clean_path(""+a),(d=this.serialize(o)).length&&(h+="?"+d),h+=n},visit:function(i,s,l){var n,r,o,a,h,d;switch(null==l&&(l=!1),h=i[0],n=i[1],o=i[2],h){case t.GROUP:return this.visit(n,s,!0);case t.STAR:return this.visit_globbing(n,s,!0);case t.LITERAL:case t.SLASH:case t.DOT:return n;case t.CAT:return r=this.visit(n,s,l),a=this.visit(o,s,l),!l||r&&a?""+r+a:"";case t.SYMBOL:if(d=s[n],null!=d)return delete s[n],this.path_identifier(d);if(l)return"";throw new e("Route parameter missing: "+n);default:throw new Error("Unknown Rails node type")}},visit_globbing:function(t,e,i){var s,l,n,r;return n=t[0],s=t[1],l=t[2],s.replace(/^\*/i,"")!==s&&(t[1]=s=s.replace(/^\*/i,"")),r=e[s],null==r?this.visit(t,e,i):(e[s]=function(){switch(this.get_object_type(r)){case"array":return r.join("/");default:return r}}.call(this),this.visit(t,e,i))},get_prefix:function(){var t;return t=s.prefix,""!==t&&(t=t.match("/$")?t:""+t+"/"),t},_classToTypeCache:null,_classToType:function(){var t,e,i,s;if(null!=this._classToTypeCache)return this._classToTypeCache;for(this._classToTypeCache={},s="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),e=0,i=s.length;i>e;e++)t=s[e],this._classToTypeCache["[object "+t+"]"]=t.toLowerCase();return this._classToTypeCache},get_object_type:function(t){var e;return window.jQuery&&null!=window.jQuery.type?window.jQuery.type(t):(e=Object.prototype.toString.call(t),this._classToType()[e]||"object")},namespace:function(t,e){var s,l;return l=e?e.split("."):[],l.length?(s=l.shift(),t[s]=t[s]||{},i.namespace(t[s],l.join("."))):void 0}},i.namespace(window,"Routes"),window.Routes={admins_root_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[7,"/",!1],[3,"score_id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cancel_user_registration_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"cancel",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cells",!1]],[7,"/",!1]],[3,"id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_api_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"api",!1]],[7,"/",!1]],[6,"cells",!1]],[7,"/",!1]],[3,"id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_set_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[3,"id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_set_grid_cell_path:function(){return i.build_path(["score_id","cell_set_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[3,"cell_set_id",!1]],[7,"/",!1]],[6,"grid_cells",!1]],[7,"/",!1]],[3,"id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_set_grid_cells_path:function(){return i.build_path(["score_id","cell_set_id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[3,"cell_set_id",!1]],[7,"/",!1]],[6,"grid_cells",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cell_sets_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cells_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cells",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},cells_api_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"api",!1]],[7,"/",!1]],[6,"cells",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},destroy_user_session_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"sign_out",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},edit_cell_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cells",!1]],[7,"/",!1]],[3,"id",!1]],[7,"/",!1]],[6,"edit",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},edit_cell_set_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[3,"id",!1]],[7,"/",!1]],[6,"edit",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},edit_cell_set_grid_cell_path:function(){return i.build_path(["score_id","cell_set_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[3,"cell_set_id",!1]],[7,"/",!1]],[6,"grid_cells",!1]],[7,"/",!1]],[3,"id",!1]],[7,"/",!1]],[6,"edit",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},edit_user_password_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"password",!1]],[7,"/",!1]],[6,"edit",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},edit_user_registration_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"edit",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},new_cell_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cells",!1]],[7,"/",!1]],[6,"new",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},new_cell_set_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"cell_sets",!1]],[7,"/",!1]],[6,"new",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},new_user_password_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"password",!1]],[7,"/",!1]],[6,"new",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},new_user_registration_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"sign_up",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},new_user_session_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"sign_in",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},root_path:function(){return i.build_path([],[],[7,"/",!1],arguments)},score_root_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[7,"/",!1],[3,"score_id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},set_api_path:function(){return i.build_path(["score_id","id"],["format"],[2,[2,[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"api",!1]],[7,"/",!1]],[6,"sets",!1]],[7,"/",!1]],[3,"id",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},sets_api_path:function(){return i.build_path(["score_id"],["format"],[2,[2,[2,[2,[2,[2,[7,"/",!1],[3,"score_id",!1]],[7,"/",!1]],[6,"api",!1]],[7,"/",!1]],[6,"sets",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},user_password_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"password",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},user_registration_path:function(){return i.build_path([],["format"],[2,[2,[7,"/",!1],[6,"users",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)},user_session_path:function(){return i.build_path([],["format"],[2,[2,[2,[2,[7,"/",!1],[6,"users",!1]],[7,"/",!1]],[6,"sign_in",!1]],[1,[2,[8,".",!1],[3,"format",!1]],!1]],arguments)}},window.Routes.options=s}).call(this),GridCell.prototype={defaultImageRegex:/default[-a-z0-9A-z]*.png$/i,init:function(){this.render(),this.addEvents(),this.setPositions()},addEvents:function(){var t=$("#gridCell_"+this.id);t.resizable({grid:[this.gridSize.width,this.gridSize.height],containment:"#grid",stop:function(t,e){this.width=e.size.width,this.height=e.size.height}}),t.draggable({grid:[this.gridSize.width,this.gridSize.height],containment:"#grid"}),$("#gridCell_"+this.id).css({width:this.width,height:this.height}),t.on("dragstop resizestop",$.proxy(this.onChangedRectangle,this)),t.on("dblclick",$.proxy(this.onDblClick,this)),t.on("click",$.proxy(this.onClickCell,this)),$(document).on("keydown",$.proxy(this.onKeyPress,this)),t.hover(onMouseIn,onMouseOut),t.children().hover(function(){},function(){})},render:function(){this.html="<div id='gridCell_"+this.id+"' class='"+this.class+"'><span id='gridCell_"+this.id+"_content'><span class='cell-image'></span><span class='cell-title'></span>"+"<span class='cell-content'></span></span></div>",$("#grid").append(this.html),this.setContent(this.title,this.description,this.src),this.gridSize=theGrid.getCellSizeAsPixels(),this.width=this.width*this.gridSize.width,this.height=this.height*this.gridSize.height},updateData:function(t){this.id=t.grid_cell.id,this.canonicalCell=t.grid_cell.canonical_cell,this.type=this.canonicalCell.type;var e=theGrid.getCellSizeAsPixels();this.x=t.grid_cell.x*e.width,this.y=t.grid_cell.y*e.height,this.width=t.grid_cell.width,this.height=t.grid_cell.height,this.title=t.grid_cell.title||"",this.description=t.grid_cell.description||"",this.updatePosterImageFromData(t)},updatePosterImageFromData:function(t){if(this.src=this.defaultImageRegex.test(t.grid_cell.poster_image.small.url)?this.canonicalCell.poster_image.small.url:t.grid_cell.poster_image.small.url,"css-z-index"in t.grid_cell.canonical_cell.additional_fields){var e=t.grid_cell.canonical_cell.additional_fields.css-z-index;this.z=e}else this.z=3},onChangedRectangle:function(){this.getAndSaveNewPositionAndSize();var t=APPLICATION.score_id,e=APPLICATION.resource_id,i=theGrid.mapPixelsToGrid(this.x,this.y),s={x:i.x,y:i.y,width:Math.round(this.width/this.gridSize.width),height:Math.round(this.height/this.gridSize.height)};$.post(Routes.cell_set_grid_cell_path(t,e,this.id),{grid_cell:s,_method:"patch"})},getAndSaveNewPositionAndSize:function(){var t=$("#gridCell_"+this.id).position();this.position=t,this.x=this.position.left,this.y=this.position.top,this.width=$("#gridCell_"+this.id).width(),this.height=$("#gridCell_"+this.id).height(),$("#gridCell_"+this.id+"_content img").css({width:this.width,height:this.height})},checkCollisions:function(){},setPositions:function(){$("#grid");var t=theGrid.mapPixelsToGrid(this.x,this.y);this.x=t.x*this.gridSize.width,this.y=t.y*this.gridSize.height,$("#gridCell_"+this.id).css({left:this.x,top:this.y,"z-index":this.z}),this.getAndSaveNewPositionAndSize()},setSrc:function(t){this.src=t},onDblClick:function(){this.openEditDialog()},onClickCell:function(){var t=this.id;$("div#gridCell_"+t).hasClass("selectedCell")?(theGrid.cellSelected=!1,$(".cell").removeClass("selectedCell")):($(".cell").removeClass("selectedCell"),$("div#gridCell_"+t).addClass("selectedCell"),theGrid.cellSelected=!0,currentCellToEdit=this)},onKeyPress:function(t){var e=t.keyCode||t.which;if(theGrid.cellSelected){if(8===e)return editBox.openConfirmDialog(currentCellToEdit.title),!1;if(27===e)return editBox.closeConfirmDialog(),!1}},openEditDialog:function(){editBox.openDialog(this),currentCellToEdit=this},setContent:function(t,e,i){this.title=t,this.description=e,this.src=i,this.updateGridCell(),this.updateContentCell()},whichDataToUse:function(t,e){var i="";return i=t.length<=0?e:t},updateGridCell:function(){var t=$("#gridCell_"+this.id+"_content"),e=this.whichDataToUse(this.title,this.canonicalCell.title),i=this.whichDataToUse(this.description,this.canonicalCell.description);if(this.src){var s=this.whichDataToUse(this.src,this.canonicalCell.poster_image.url),l=$(t).find(".cell-image");l.find("img").length>0?l.find("img").attr("src",s):l.html("<img src='"+s+"'></img>"),$(t).find(".cell-title").html(""),$(t).find(".cell-content").html("")}else $(t).find(".cell-image").html(""),$(t).find(".cell-title").html(e),$(t).find(".cell-content").html(i)},updateContentCell:function(){var t=$("#usedContentCell_"+this.id),e=this.whichDataToUse(this.title,this.canonicalCell.title),i=this.whichDataToUse(this.description,this.canonicalCell.description);if(this.src){var s=this.whichDataToUse(this.src,this.canonicalCell.poster_image.url);$(t).find(".contentCellPosterImage").html("<img src='"+s+"'></img>")}$(t).find(".contentCellTitle").html(e),$(t).find(".contentCellDescription").html(i),$(t).find(".badge").html(this.type)}},Grid.prototype={init:function(){this.container.css({width:this.width,height:this.height}),$(".cell").css({width:this.widthStep,height:this.heightStep}),this.saveCellSizeAsPixels(),this.container.prepend(this.drawGridMesh());var t='<div><span id="removeRow">-</span><span id="addRow">+</span></div>',e='<div><span id="removeColumn">-</span><span id="addColumn">+</span></div>';$("#boundsForGrid").append(t),$("#addRow").click($.proxy(this.addRow,this)),$("#removeRow").click($.proxy(this.removeRow,this)),$("#boundsForGrid").append(e),$("#addColumn").click($.proxy(this.addColumn,this)),$("#removeColumn").click($.proxy(this.removeColumn,this)),this.setPositionsOfButtons()},saveCellSizeAsPixels:function(){var t=parseInt(this.widthStep,10),e=parseInt(this.heightStep,10);this.cellSize={width:t,height:e}},getCellSizeAsPixels:function(){return this.cellSize},mapPixelsToGrid:function(t,e){var i=this.getCellSizeAsPixels(),s=Math.floor(t/i.width),l=Math.floor(e/i.height);return{x:s,y:l}},setPositionsOfButtons:function(){$("#grid").css({width:this.width,height:this.height}),$("#boundsForGrid").css({height:this.height+2*this.cellSize.height});var t=$("#addRow"),e=$("#removeRow"),i=$("#addColumn"),s=$("#removeColumn"),l=i.parent().parent();i.css({left:l.width()-i.width(),height:l.height()/2,top:l.height()/2,"padding-top":.16*l.height()}),s.css({left:l.width()-i.width(),height:l.height()/2,"padding-top":.16*l.height()}),t.css({top:l.height()-t.height(),width:l.width()/2,left:l.width()/2}),e.css({top:l.height()-t.height(),width:l.width()/2})},persistSetSize:function(){var t=APPLICATION.score_id,e=APPLICATION.resource_id,i=this.width/parseInt(this.widthStep),s=this.height/parseInt(this.heightStep);$.post(Routes.cell_set_path(t,e),{cell_set:{columns:i,rows:s},_method:"patch"})},addColumn:function(){this.width<this.boundsWidth?(this.width+=this.cellSize.width,this.setPositionsOfButtons(),this.persistSetSize()):alert("Maximum Columns reached! Maximum is: "+this.boundsWidth/parseInt(this.widthStep)),console.log("added column"),$(".cellTable").width($(".cellTable").width()-this.cellSize.width)},removeColumn:function(){var t=0,e=this.width;$.each(this.cells,function(i,s){s.x+s.width>=e&&t++}),0==t?(this.width-=this.cellSize.width,this.setPositionsOfButtons(),this.persistSetSize()):alert("There is a cell in the column you want to remove!\nPlease delete or move this cell.")},addRow:function(){this.height<this.boundsHeight?(this.height+=this.cellSize.height,this.setPositionsOfButtons(),this.persistSetSize()):alert("Maximum Rows reached! Maximum is: "+this.boundsHeight/parseInt(this.heightStep)),$(".cellTable").height($(".cellTable").height()-this.cellSize.height),console.log("added row")},removeRow:function(){var t=0,e=this.height;$.each(this.cells,function(i,s){s.y+s.height>=e&&t++}),0==t?(this.height-=this.cellSize.height,this.setPositionsOfButtons(),this.persistSetSize()):alert("There is a cell in the row you want to remove!\nPlease delete or move this cell."),$(".cellTable").height($(".cellTable").height()+this.cellSize.height)},removeCell:function(t){$("#gridCell_"+t.id).remove(),$("#usedContentCell_"+t.id).remove(),$("#dialog-modal").dialog("close"),this.cells=$.grep(this.cells,function(e){return e.id==t.id?!1:!0}),this.cellSelected=!1},addCell:function(t){this.cells.push(t)},setCurrentCell:function(t){$.each(this.cells,function(e,i){return i.id==t?(currentCellToEdit=i,!1):void 0})},onWindowResize:function(){console.log($(window).width()),$("boundsForGrid").css({width:$("boundsForGrid").parent().width(),height:this.boundsHeight}),this.container.css({width:this.width,height:this.height}),this.saveCellSizeAsPixels(),this.container.prepend(this.drawGridMesh()),$(".cell").css({width:this.widthStep,height:this.heightStep})},drawGridMesh:function(){this.container.find("svg").remove();var t=this.getCellSizeAsPixels(),e=t.width,i=t.height,s="M "+e+" 0 L 0 0 0 "+i,l='<path d="'+s+'" fill="none" stroke="#fff" stroke-width="1"/>',n='<pattern id="gridPattern" width="'+e+'" height="'+i+'" patternUnits="userSpaceOnUse">'+l+"</pattern>",r='<rect width="100%" height="100%" fill="url(#gridPattern)" />',o='<svg width="100%" height="100%"><defs>'+n+"</defs>"+r+"</svg>";return o}},EditDialog.prototype={init:function(){this.initDialog(),this.initModal(),this.initForm()},initDialog:function(){$("#dialog-modal").dialog({height:500,autoOpen:!1,modal:!0})},initModal:function(){$("#dialog-confirm").dialog({modal:!0,autoOpen:!1,buttons:{Ok:function(){removeSelectedCell(),$(this).dialog("close")}}})},initForm:function(){this.editForm=$("#dialog-modal"),this.addAdditionalAttributesTemplate=JST["templates/additional_field"]},submitForm:function(t){var e=$("#dialog-modal").find("form"),i=new FormData(e[0]),s=function(t){var i=e.find("#editTitle").val(),s=e.find("#editDescription").val();currentCellToEdit.updatePosterImageFromData(t);var l=currentCellToEdit.src;currentCellToEdit.setContent(i,s,l),editBox.closeDialog()};$.ajax({url:e.attr("action"),type:"POST",data:i,success:s,cache:!1,contentType:!1,processData:!1}),t.preventDefault()},deleteImage:function(t){$("#editImageSrc").val(""),$("#usedPosterImage").hide().attr("src",""),$("#removeImageSrc").val("1"),this.showDisplayDeleteBtn(),t.preventDefault()},uploadNewImage:function(){$("#editImageSrc").val($("#cell_poster_image").val()),$("#usedPosterImage").attr("src",$("#cell_poster_image").val()).show(),this.showDisplayDeleteBtn()},addAdditionalAttributes:function(){$("#specialAttributes").append(this.addAdditionalAttributesTemplate)},addEvents:function(){$("#removeCell").on("click",removeSelectedCell),$("#deleteImage").on("click",$.proxy(this.deleteImage,this)),$(".form_submit").on("click",this.submitForm),$("#addSpecialAttribute").on("click",$.proxy(this.addAdditionalAttributes,this)),$("#cell_poster_image").on("change",$.proxy(this.uploadNewImage,this)),this.showDisplayDeleteBtn()},showDisplayDeleteBtn:function(){""==$("#usedPosterImage").attr("src")?$("#deleteImage").hide():$("#deleteImage").show()},closeDialog:function(){theGrid.cellSelected=!0,$("#dialog-modal").dialog("close")},openDialog:function(t){theGrid.cellSelected=!1,this.model=t,this.editForm.empty(),this.model.canonicalCell.poster_image.medium.url===this.model.src&&(this.model.src=null);var e=this.model.additional_fields,i=APPLICATION.score_id,s=APPLICATION.resource_id;this.formTemplate=JST["templates/edit_cell"]({data:this.model,formTargetUrl:Routes.cell_set_grid_cell_path(i,s,this.model.id),usedCellAdditionalFields:e}),this.editForm.append(this.formTemplate),this.addEvents(),$("#dialog-modal").dialog("open")},openConfirmDialog:function(t){t&&$("#dialog-confirm").find("#cell-title-todelete").html("<li>"+t+"</li>"),$("#dialog-confirm").dialog("open")},closeConfirmDialog:function(){$("#dialog-confirm").dialog("close")}};var currentMousePos={x:-1,y:-1},currentCellToEdit,theGrid;$(document).ready(function(){function t(){$(document).mousemove(function(t){currentMousePos.x=t.pageX,currentMousePos.y=t.pageY})}function e(){initTabs(),initTableEvents();var t=APPLICATION.columns||3,e=APPLICATION.rows||3;theGrid=new Grid(t,e,25,15,"50px","25px"),editBox=new EditDialog("Default Title","text","Default Description","");var i=APPLICATION.score_id;$.get(Routes.cell_set_grid_cells_path(i,APPLICATION.resource_id),populateTheGrid),initFilter(),setScrollbarHeight(),$(window).on("resize",setScrollbarHeight)}t(),e()});